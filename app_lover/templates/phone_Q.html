{% load static %}
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="black">
    <title>ã‚¯ã‚¤ã‚º</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .header {
            position: sticky;
            display: flex;
            top: 0;
            justify-content: space-between;
            /* å­è¦ç´ ã‚’å·¦å³ã«é…ç½® */
            background-color: #333;
            color: white;
            padding: 10px 40px;
            align-items: center;
            z-index: 1000;
            /* ä»–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ˆã‚Šã‚‚ä¸Šã«è¡¨ç¤º */
        }

        .header .welcome {
            font-size: 16px;
            /* æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
        }

        .header .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 25px;

        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .content {
            padding: 20px;
            height: 2000px;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãŸã‚ã«é«˜ã•ã‚’è¿½åŠ  */
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }

        .link-card {
            position: relative;
            width: 40vw;
            height: 40vw;
            background: #fff;
            border-radius: 20px;
            box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            padding: 10px 10px 10px 10px;
        }

        .link-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .clear-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            pointer-events: none;
            /* ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ */
            animation: clear_zoomIn 0.8s cubic-bezier(1, 1, 0.5, 1) forwards;
        }

        @keyframes clear_zoomIn {
            0% {
                transform: scale(2);
                /* åˆæœŸçŠ¶æ…‹ */
            }

            100% {
                transform: scale(1);
                /* çµ‚äº†çŠ¶æ…‹ */
            }
        }


        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
            /* åˆæœŸè¡¨ç¤ºæ™‚ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(-50px);
                /* ä¸Šã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ */
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(50px);
                /* ä¸‹ã«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆ */
            }
        }

        .modal-content {
            background-color: #333;
            padding: 20px;
            border-radius: 40px;
            text-align: center;
            color: white;
            position: relative;
            /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’å³ä¸Šã«é…ç½®ã™ã‚‹ãŸã‚ã«è¦ªè¦ç´ ã«relativeã‚’è¿½åŠ  */
        }

        .modal input {
            margin: 10px 0;
            padding: 10px;
            width: 200px;
            font-size: 16px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: red;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‹ã¨ã */
        .modal.hide {
            animation: fadeOut 0.5s ease-out forwards;
        }

        .modal button {
            padding: 10px 20px;
            background-color: green;
            color: white;
            border: none;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal button:hover {
            background-color: darkgreen;
        }


        #my_container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-flow: wrap;
            justify-content: space-around;
            align-items: center;
        }

        #my_inner {
            margin: 0px;
            padding: 10px 10px;
            border-radius: 20px;
            background-color: gray;
            color: white;
            font-size: 2rem;
            text-align: center;
        }

        #my_quagga {
            width: 320px;
            height: 240px;
            margin: 5px;
            padding: 0px;
            position: relative;
            background-color: silver;
        }

        #my_quagga video {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #my_quagga canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #my_result {
            width: 100%;
            height: 100%;
            font-size: 1rem;
            text-align: center;
        }

        #my_barcode {
            width: 100%;
            height: 100%;
            display: flex;
            flex-flow: wrap;
            justify-content: space-around;
            align-items: center;
        }
        canvas { display: block; 
            z-index: 1001;}
        #startBtn {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            background-color: #008CBA;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!--å®Œäº† Q01,Q2,Q04-->
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="Q01" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('Q01')">&times;</span>
            Q01,ç”»åƒã®é€šã‚Šã«ã—ã‚
            <hr color="#fffff">
            <img src="{% static 'lover/images/phone_rotate.jpg' %}" width="60%">

        </div>
        <script>
            window.addEventListener("orientationchange", function () {
                if (window.getComputedStyle(document.getElementById("Q01")).display != "none") {
                    alert("Q01ã‚¯ãƒªã‚¢ï¼ï¼\nå‘ããŒå¤‰ã‚ã£ãŸï¼ï¼ï¼");
                    const formData = new FormData();
                    formData.append("message", "Q01=True");

                    fetch("{% url 'phone' %}", {  // Djangoã®URL
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: formData  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡
                    })
                        .then(response => response.json())
                        .then(data => {
                            window.location.reload();
                        })
                        .catch(error => console.error("Error:", error));
                }
            });
        </script>
    </div>
    <div id="Q02" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('Q02')">&times;</span>
            Q02, åˆè¨€è‘‰ã‚’åŸ‹ã‚ã‚
            <hr color="#fffff">
            åº§æ¨™:X=470 Y=64 Z=-375
            <input type="text" name="message" id="Q2_message" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" required>
            <button id="Q2_button">é€ä¿¡</button>
        </div>
    </div>

    <script>
        document.getElementById("Q2_button").addEventListener("click", function (event) {
            var message = document.getElementById("Q2_message").value;
            if (message == "ãƒ‘ã‚ºãƒ«") {  // åˆè¨€è‘‰ãƒã‚§ãƒƒã‚¯
                alert("Q02ã‚¯ãƒªã‚¢ï¼ï¼\nåˆè¨€è‘‰ã‚’å…¥åŠ›ã—ãŸï¼ï¼ï¼");
                const formData = new FormData();
                formData.append("message", "Q02=True");

                fetch("{% url 'phone' %}", {  // Djangoã®URL
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: formData  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡
                })
                    .then(response => response.json())
                    .then(data => {
                        window.location.reload();
                    })
                    .catch(error => console.error("Error:", error));

            }
            else {
                alert("é•ã†ã‚ˆï¼ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã‚ˆã†ã€‚");  // è­¦å‘Šã‚’è¡¨ç¤º
            }
        });
    </script>

    </div>
    <div id="Q03" class="modal">
        <form method="POST" action="{% url 'phone_name_birthday' %}">
            {% csrf_token %}
            <div class="modal-content">
                ç‰¹å®šã®å ´æ‰€ã¸è¡Œã‘
                <span class="modal-close" onclick="closeModal('Q03')">&times;</span>
                <hr>
                <input type="text" name="name" id="name" placeholder="åå‰" required>
                <br>
                <label for="birthdate">èª•ç”Ÿæ—¥:</label>
                <input type="date" name="birth_date" id="birthdate" placeholder="èª•ç”Ÿæ—¥" required>
                <br>
                <button type="submit">é€ä¿¡</button>
            </div>
        </form>
    </div>
    <div id="Q04" class="modal">
        <div class="modal-content">
            ãƒã‚«ãƒªã‚¹ã‚¨ãƒƒãƒˆ500mlã‚’è³¼å…¥ã—ã¦<br>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚
            <span class="modal-close" onclick="closeModal('Q04')">&times;</span>
            <hr>

            <div id="my_container">
                <div id="my_inner">
                    <div>= QuaggaJS =</div>
                    <div>
                        <button id="startCamera">Start</button>
                        <button id="changeCamera">Change Camera</button>

                    </div>
                    <div id="my_quagga"></div>
                    <div id="my_result">***</div>
                    <div id="my_barcode">
                        <div>***</div>
                    </div>
                </div>
            </div>
        </div>
        <script src="//code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="//unpkg.com/@ericblade/quagga2@1.7.4/dist/quagga.min.js"></script>
        <script src="//cdn.jsdelivr.net/gh/mtaketani113/jquery-barcode@master/jquery-barcode.js"></script>
        <script>

            let cameras = [];
            let currentCameraIndex = 0;

            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    cameras = devices.filter(device => device.kind === "videoinput");
                })
                .catch(err => console.log("Camera enumeration error:", err));

            function startQuagga(cameraId) {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: "#my_quagga",
                        constraints: {
                            facingMode: "environment",
                            deviceId: cameraId ? { exact: cameraId } : undefined
                        }
                    },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader"]
                    }
                }, err => {
                    if (err) {
                        console.log("Quagga init error:", err);
                        return;
                    }
                    console.log("Initialization finished!!");
                    Quagga.start();
                    console.log("Quagga started!");
                });
            }
            function stopQuagga() {
                let video = document.querySelector("#my_quagga video");
                let canvas = Quagga.canvas.dom.overlay; // Quaggaã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å–å¾—

                if (video && canvas) {
                    let ctx = canvas.getContext("2d");
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    video.remove(); // å‹•ç”»ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å‰Šé™¤
                }

                Quagga.stop();
            }

            document.getElementById("changeCamera").addEventListener("click", () => {
                if (cameras.length > 1) {
                    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
                    Quagga.stop();
                    startQuagga(cameras[currentCameraIndex].deviceId);
                }
            });

            document.getElementById("startCamera").addEventListener("click", () => {
                if (document.getElementById("startCamera").textContent == "Start") {
                    startQuagga();
                    document.getElementById("startCamera").textContent = "Stop";
                }
                else {
                    stopQuagga();
                    document.getElementById("startCamera").textContent = "Start";
                }
            })



            Quagga.onProcessed(result => {
                if (result == null) return;
                if (typeof (result) != "object") return;
                if (result.boxes == undefined) return;
                const ctx = Quagga.canvas.ctx.overlay;
                const canvas = Quagga.canvas.dom.overlay;
                ctx.clearRect(0, 0, parseInt(canvas.width), parseInt(canvas.height));
                Quagga.ImageDebug.drawPath(result.box,
                    { x: 0, y: 1 }, ctx, { color: "blue", lineWidth: 5 });
            });

            Quagga.onDetected(result => {
                console.log(result.codeResult.code);
                $("#my_result").text(result.codeResult.code);
                if (result.codeResult.code == "45019517") {//ãƒã‚«ãƒª
                    stopQuagga();
                    $("#my_result").text("æˆåŠŸ");
                }
                $("#my_barcode div").barcode(result.codeResult.code, "ean13");
            });


        </script>
    </div>
    <div id="Q05" class="modal">
        <div class="modal-content">
            ç‰¹å®šã®å ´æ‰€ã¸è¡Œã‘
            <span class="modal-close" onclick="closeModal('Q05')">&times;</span>
            <hr>
            <button id="startBtn" onclick="requestPermission()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <h1>ã‚¹ãƒãƒ›ã®å‚¾ãæ¤œçŸ¥</h1>
            <div id="box"></div>
            <p id="info">å‚¾ãã‚’æ¤œçŸ¥ä¸­...</p>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        <script>
            let scene, camera, renderer, puzzlePiece;
            let targetRotationX = 0, targetRotationY = 0;
            let correctRotationX = Math.PI / 4;
            let correctRotationY = Math.PI / 6;
    
            function init() {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
    
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);
    
                // å‡¹å‡¸ã®ã‚ã‚‹ãƒ‘ã‚ºãƒ«å½¢çŠ¶ã‚’ä½œæˆ
                const shape = new THREE.Shape();
                shape.moveTo(-1, -1);
                shape.lineTo(1, -1);
                shape.lineTo(1, 1);
                shape.lineTo(-1, 1);
                shape.lineTo(-1, -1);
    
                const extrudeSettings = { depth: 0.5, bevelEnabled: true, bevelThickness: 0.2, bevelSize: 0.2, bevelSegments: 5 };
                const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                const material = new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.3, roughness: 0.6 });
                
                puzzlePiece = new THREE.Mesh(geometry, material);
                puzzlePiece.rotation.x = Math.random() * Math.PI;
                puzzlePiece.rotation.y = Math.random() * Math.PI;
                scene.add(puzzlePiece);
    
                // ãƒ©ã‚¤ãƒˆè¿½åŠ 
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(2, 2, 5);
                scene.add(light);
    
                animate();
            }
    
            function animate() {
                requestAnimationFrame(animate);
                
                // ã‚¹ãƒãƒ›ã®å‚¾ãã§å›è»¢ã‚’èª¿æ•´
                puzzlePiece.rotation.x += (targetRotationX - puzzlePiece.rotation.x) * 0.1;
                puzzlePiece.rotation.y += (targetRotationY - puzzlePiece.rotation.y) * 0.1;
    
                renderer.render(scene, camera);
    
                // è§’åº¦ãŒæ­£è§£ã«è¿‘ã¥ã„ãŸã‚‰ã‚¯ãƒªã‚¢
                if (Math.abs(puzzlePiece.rotation.x - correctRotationX) < 0.1 && Math.abs(puzzlePiece.rotation.y - correctRotationY) < 0.1) {
                    alert("ã‚¯ãƒªã‚¢ï¼ğŸ‰");
                    window.removeEventListener("deviceorientation", handleOrientation);
                }
            }
    
            function handleOrientation(event) {
                let beta = event.beta ?? 0;  // å‰å¾Œã®å‚¾ã
                let gamma = event.gamma ?? 0; // å·¦å³ã®å‚¾ã
    
                targetRotationX = (beta / 180) * Math.PI;  // -180~180åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
                targetRotationY = (gamma / 90) * Math.PI;  // -90~90åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
            }
    
            function requestPermission() {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener("deviceorientation", handleOrientation, true);
                                init();
                            } else {
                                alert("ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™");
                            }
                        })
                        .catch(error => console.error("è¨±å¯ã‚¨ãƒ©ãƒ¼:", error));
                } else {
                    window.addEventListener("deviceorientation", handleOrientation, true);
                    init();
                }
            }
        </script>
    </div>
    <div id="Q06" class="modal">
            <div class="modal-content">
                ç‰¹å®šã®å ´æ‰€ã¸è¡Œã‘
                <span class="modal-close" onclick="closeModal('Q06')">&times;</span>
                <hr>
                
            </div>
            
    </div>
    <h1>ã‚¯ã‚¤ã‚ºã‚’é¸æŠ</h1>
    <div class="container" id="container">
    </div>

    <script>
        function showModal(id) {
            var modal = document.getElementById(id);
            modal.classList.remove('hide'); // é–‰ã˜ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            modal.style.display = 'flex';
        }
        function closeModal(id) {
            var modal = document.getElementById(id);
            modal.classList.add('hide'); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            setTimeout(function () {
                modal.style.display = 'none'; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«å®Œå…¨ã«éè¡¨ç¤ºã«ã™ã‚‹
            }, 500); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ã¨åˆã‚ã›ã‚‹
        }

        window.onload = function () {
            // container è¦ç´ ã‚’å–å¾—
            const container = document.getElementById('container');

            // 6å›ç¹°ã‚Šè¿”ã—
            for (let i = 1; i <= 6; i++) {
                // link-card ã® div ã‚’ä½œæˆ
                const linkCard = document.createElement('div');
                linkCard.classList.add('link-card');
                linkCard.setAttribute('onclick', `showModal('Q0${i}')`);
                linkCard.id = `Q0${i}_card`;
                image = document.createElement('img')
                image.src = "{% static 'lover/images/q'%}" + i.toString() + ".png";
                linkCard.appendChild(image);
                // link-card ã‚’ container ã«è¿½åŠ 
                container.appendChild(linkCard);
            }

            if ('{{data.game01}}' == "True") {
                // ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®å‡¦ç†
                clear_card(1);
            }
            if ('{{data.game02}}' == "True") {
                // ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®å‡¦ç†
                clear_card(2);
            }
            if ('{{data.game03}}' == "True") {
                // ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®å‡¦ç†
                clear_card(3);
            }
            if ('{{data.game04}}' == "True") {
                // ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®å‡¦ç†
                clear_card(4);
            }
            if ('{{data.game05}}' == "True") {
                // ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®å‡¦ç†
                clear_card(5);
            }
            if ('{{data.game06}}' == "True") {
                // ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã®å‡¦ç†
                clear_card(6);
            }
            function clear_card(id) {
                const overlayImage = document.createElement('img');
                overlayImage.src = "{% static 'lover/images/clear.png' %}";
                overlayImage.classList.add("clear-overlay");
                document.getElementById(`Q0${id}_card`).appendChild(overlayImage);  // clear.png ã‚’ linkCard ã«è¿½åŠ 
                document.getElementById(`Q0${id}_card`).removeAttribute('onclick');
            }
        };

    </script>
</body>

</html>