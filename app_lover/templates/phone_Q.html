{% load static %}
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="black">
    <title>クイズ</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        /* ヘッダーのスタイル */
        .header {
            position: sticky;
            display: flex;
            top: 0;
            justify-content: space-between;
            /* 子要素を左右に配置 */
            background-color: #333;
            color: white;
            padding: 10px 40px;
            align-items: center;
            z-index: 1000;
            /* 他のコンテンツよりも上に表示 */
        }

        .header .welcome {
            font-size: 16px;
            /* 文字サイズ調整 */
        }

        .header .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 25px;

        }

        /* メインコンテンツのスタイル */
        .content {
            padding: 20px;
            height: 2000px;
            /* スクロールのために高さを追加 */
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }

        .link-card {
            position: relative;
            width: 40vw;
            height: 40vw;
            background: #fff;
            border-radius: 20px;
            box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            padding: 10px 10px 10px 10px;
        }

        .link-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .clear-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            pointer-events: none;
            /* クリックできないようにする */
            animation: clear_zoomIn 0.8s cubic-bezier(1, 1, 0.5, 1) forwards;
        }

        @keyframes clear_zoomIn {
            0% {
                transform: scale(2);
                /* 初期状態 */
            }

            100% {
                transform: scale(1);
                /* 終了状態 */
            }
        }


        /* モーダルのスタイル */
        .modal {
            display: none;
            /* 初期状態では非表示 */
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
            /* 初期表示時のフェードイン */
        }

        /* モーダルが表示されるとき */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(-50px);
                /* 上からスライドイン */
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* モーダルを閉じる時のアニメーション */
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(50px);
                /* 下にスライドアウト */
            }
        }

        .modal-content {
            background-color: #333;
            padding: 20px;
            border-radius: 40px;
            text-align: center;
            color: white;
            position: relative;
            /* 閉じるボタンを右上に配置するために親要素にrelativeを追加 */
        }

        .modal input {
            margin: 10px 0;
            padding: 10px;
            width: 200px;
            font-size: 16px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: red;
        }

        /* モーダルが閉じるとき */
        .modal.hide {
            animation: fadeOut 0.5s ease-out forwards;
        }

        .modal button {
            padding: 10px 20px;
            background-color: green;
            color: white;
            border: none;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal button:hover {
            background-color: darkgreen;
        }


        #my_container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-flow: wrap;
            justify-content: space-around;
            align-items: center;
        }

        #my_inner {
            margin: 0px;
            padding: 10px 10px;
            border-radius: 20px;
            background-color: gray;
            color: white;
            font-size: 2rem;
            text-align: center;
        }

        #my_quagga {
            width: 320px;
            height: 240px;
            margin: 5px;
            padding: 0px;
            position: relative;
            background-color: silver;
        }

        #my_quagga video {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #my_quagga canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #my_result {
            width: 100%;
            height: 100%;
            font-size: 1rem;
            text-align: center;
        }

        #my_barcode {
            width: 100%;
            height: 100%;
            display: flex;
            flex-flow: wrap;
            justify-content: space-around;
            align-items: center;
        }

        canvas {
            display: block;
            z-index: 1001;
        }

        #startBtn {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            background-color: #008CBA;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!--完了 Q01,Q2,Q04-->
    <!-- モーダル -->
    <div id="Q01" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('Q01')">&times;</span>
            Q01,画像の通りにしろ
            <hr color="#fffff">
            <img src="{% static 'lover/images/phone_rotate.jpg' %}" width="60%">

        </div>
        <script>
            window.addEventListener("orientationchange", function () {
                if (window.getComputedStyle(document.getElementById("Q01")).display != "none") {
                    alert("Q01クリア！！\n向きが変わった！！！");
                    const formData = new FormData();
                    formData.append("message", "Q01=True");

                    fetch("{% url 'phone' %}", {  // DjangoのURL
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: formData  // フォームデータとして送信
                    })
                        .then(response => response.json())
                        .then(data => {
                            window.location.reload();
                        })
                        .catch(error => console.error("Error:", error));
                }
            });
        </script>
    </div>
    <div id="Q02" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('Q02')">&times;</span>
            Q02, 合言葉を埋めろ
            <hr color="#fffff">
            座標:X=470 Y=64 Z=-375
            <input type="text" name="message" id="Q2_message" placeholder="合言葉を入力" required>
            <button id="Q2_button">送信</button>
        </div>
    </div>

    <script>
        document.getElementById("Q2_button").addEventListener("click", function (event) {
            var message = document.getElementById("Q2_message").value;
            if (message == "パズル") {  // 合言葉チェック
                alert("Q02クリア！！\n合言葉を入力した！！！");
                const formData = new FormData();
                formData.append("message", "Q02=True");

                fetch("{% url 'phone' %}", {  // DjangoのURL
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: formData  // フォームデータとして送信
                })
                    .then(response => response.json())
                    .then(data => {
                        window.location.reload();
                    })
                    .catch(error => console.error("Error:", error));

            }
            else {
                alert("違うよ！もう一度考えてみよう。");  // 警告を表示
            }
        });
    </script>

    </div>
    <div id="Q03" class="modal">
        <form method="POST" action="{% url 'phone_name_birthday' %}">
            {% csrf_token %}
            <div class="modal-content">
                特定の場所へ行け
                <span class="modal-close" onclick="closeModal('Q03')">&times;</span>
                <hr>
                <input type="text" name="name" id="name" placeholder="名前" required>
                <br>
                <label for="birthdate">誕生日:</label>
                <input type="date" name="birth_date" id="birthdate" placeholder="誕生日" required>
                <br>
                <button type="submit">送信</button>
            </div>
        </form>
    </div>
    <div id="Q04" class="modal">
        <div class="modal-content">
            ポカリスエット500mlを購入して<br>バーコードを読み込め
            <span class="modal-close" onclick="closeModal('Q04')">&times;</span>
            <hr>

            <div id="my_container">
                <div id="my_inner">
                    <div>= QuaggaJS =</div>
                    <div>
                        <button id="startCamera">Start</button>
                        <button id="changeCamera">Change Camera</button>

                    </div>
                    <div id="my_quagga"></div>
                    <div id="my_result">***</div>
                    <div id="my_barcode">
                        <div>***</div>
                    </div>
                </div>
            </div>
        </div>
        <script src="//code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="//unpkg.com/@ericblade/quagga2@1.7.4/dist/quagga.min.js"></script>
        <script src="//cdn.jsdelivr.net/gh/mtaketani113/jquery-barcode@master/jquery-barcode.js"></script>
        <script>

            let cameras = [];
            let currentCameraIndex = 0;

            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    cameras = devices.filter(device => device.kind === "videoinput");
                })
                .catch(err => console.log("Camera enumeration error:", err));

            function startQuagga(cameraId) {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: "#my_quagga",
                        constraints: {
                            facingMode: "environment",
                            deviceId: cameraId ? { exact: cameraId } : undefined
                        }
                    },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader"]
                    }
                }, err => {
                    if (err) {
                        console.log("Quagga init error:", err);
                        return;
                    }
                    console.log("Initialization finished!!");
                    Quagga.start();
                    console.log("Quagga started!");
                });
            }
            function stopQuagga() {
                let video = document.querySelector("#my_quagga video");
                let canvas = Quagga.canvas.dom.overlay; // Quaggaのオーバーレイを取得

                if (video && canvas) {
                    let ctx = canvas.getContext("2d");
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    video.remove(); // 動画ストリームを削除
                }

                Quagga.stop();
            }

            document.getElementById("changeCamera").addEventListener("click", () => {
                if (cameras.length > 1) {
                    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
                    Quagga.stop();
                    startQuagga(cameras[currentCameraIndex].deviceId);
                }
            });

            document.getElementById("startCamera").addEventListener("click", () => {
                if (document.getElementById("startCamera").textContent == "Start") {
                    startQuagga();
                    document.getElementById("startCamera").textContent = "Stop";
                }
                else {
                    stopQuagga();
                    document.getElementById("startCamera").textContent = "Start";
                }
            })



            Quagga.onProcessed(result => {
                if (result == null) return;
                if (typeof (result) != "object") return;
                if (result.boxes == undefined) return;
                const ctx = Quagga.canvas.ctx.overlay;
                const canvas = Quagga.canvas.dom.overlay;
                ctx.clearRect(0, 0, parseInt(canvas.width), parseInt(canvas.height));
                Quagga.ImageDebug.drawPath(result.box,
                    { x: 0, y: 1 }, ctx, { color: "blue", lineWidth: 5 });
            });

            Quagga.onDetected(result => {
                console.log(result.codeResult.code);
                $("#my_result").text(result.codeResult.code);
                if (result.codeResult.code == "45019517") {//ポカリ
                    stopQuagga();
                    $("#my_result").text("成功");
                }
                $("#my_barcode div").barcode(result.codeResult.code, "ean13");
            });


        </script>
    </div>
    <div id="Q05" class="modal">
        <div class="modal-content">
            特定の場所へ行け
            <span class="modal-close" onclick="closeModal('Q05')">&times;</span>
            <hr>
            <button id="startBtn" onclick="requestPermission()">ゲーム開始</button>
            <h1>スマホの傾き検知</h1>
            <div id="box"></div>
            <p id="info">傾きを検知中...</p>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        <script>
            let scene, camera, renderer, pointCloud;
            let targetRotationX = 0, targetRotationY = 0;

            function init(imageData) {
                scene = new THREE.Scene();
                const zoom = 5;  // カメラのズームレベルを調整
                const aspect = window.innerWidth / window.innerHeight;
                camera = new THREE.OrthographicCamera(-zoom * aspect, zoom * aspect, zoom, -zoom, 0.1, 1000);
                camera.position.z = 5;

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                const geometry = new THREE.BufferGeometry();
                const vertices = [];
                const colors = [];
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;

                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 2;

                for (let y = 0; y < height; y += 4) {
                    for (let x = 0; x < width; x += 4) {
                        let index = (y * width + x) * 4;
                        let r = data[index] / 255;
                        let g = data[index + 1] / 255;
                        let b = data[index + 2] / 255;
                        let a = data[index + 3] / 255;

                        if (a > 0.1) {
                            let normX = (x - centerX) / radius;
                            let normY = (y - centerY) / radius;
                            let distance = Math.sqrt(normX * normX + normY * normY);

                            let angle = Math.atan2(normY, normX);
                            let adjustedX = Math.cos(angle) * distance * 2;
                            let adjustedY = Math.sin(angle) * distance * 2;

                            let posX = adjustedX;
                            let posY = -adjustedY;
                            let posZ = (Math.random() - 0.5) * 0; // Z方向のランダム範囲を拡大（±1.5 → ±3）

                            vertices.push(posX, posY, posZ);
                            colors.push(r, g, b);
                        }
                    }
                }

                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

                const material = new THREE.PointsMaterial({ vertexColors: true, size: 0.05 });
                pointCloud = new THREE.Points(geometry, material);
                scene.add(pointCloud);

                animate();
            }
            // ウィンドウのリサイズ時にカメラとレンダラーを更新
            window.addEventListener('resize', () => {
                const aspect = window.innerWidth / window.innerHeight;
                const zoom = 5;  // カメラのズームレベルを調整
                camera.left = -zoom * aspect;
                camera.right = zoom * aspect;
                camera.top = zoom;
                camera.bottom = -zoom;
                camera.updateProjectionMatrix();

                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            function animate() {
                requestAnimationFrame(animate);

                pointCloud.rotation.x += (targetRotationX - pointCloud.rotation.x) * 0.1;
                pointCloud.rotation.y += (targetRotationY - pointCloud.rotation.y) * 0.1;

                renderer.render(scene, camera);
            }

            function handleOrientation(event) {
                let beta = event.beta ?? 0;
                let gamma = event.gamma ?? 0;

                targetRotationX = (beta / 180) * Math.PI;
                targetRotationY = (gamma / 90) * Math.PI;
            }

            function loadImage(url, callback) {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = url;
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, img.width, img.height);
                    callback(imageData);
                };
            }

            function requestPermission() {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener("deviceorientation", handleOrientation, true);
                                loadImage("{% static 'lover/images/Q5y.jpg' %}", init);
                            } else {
                                alert("センサーの許可が必要です");
                            }
                        })
                        .catch(error => console.error("許可エラー:", error));
                } else {
                    window.addEventListener("deviceorientation", handleOrientation, true);
                    loadImage("{% static 'lover/images/Q5y.jpg' %}", init);
                }
            }
        </script>
    </div>
    <div id="Q06" class="modal">
        <div class="modal-content">
            特定の場所へ行け
            <span class="modal-close" onclick="closeModal('Q06')">&times;</span>
            <hr>

        </div>

    </div>
    <h1>クイズを選択</h1>
    <div class="container" id="container">
    </div>

    <script>
        function showModal(id) {
            var modal = document.getElementById(id);
            modal.classList.remove('hide'); // 閉じるアニメーションをリセット
            modal.style.display = 'flex';
        }
        function closeModal(id) {
            var modal = document.getElementById(id);
            modal.classList.add('hide'); // モーダルを閉じる
            setTimeout(function () {
                modal.style.display = 'none'; // アニメーション後に完全に非表示にする
            }, 500); // アニメーションの時間と合わせる
        }

        window.onload = function () {
            // container 要素を取得
            const container = document.getElementById('container');

            // 6回繰り返し
            for (let i = 1; i <= 6; i++) {
                // link-card の div を作成
                const linkCard = document.createElement('div');
                linkCard.classList.add('link-card');
                linkCard.setAttribute('onclick', `showModal('Q0${i}')`);
                linkCard.id = `Q0${i}_card`;
                image = document.createElement('img')
                image.src = "{% static 'lover/images/q'%}" + i.toString() + ".png";
                linkCard.appendChild(image);
                // link-card を container に追加
                container.appendChild(linkCard);
            }

            if ('{{data.game01}}' == "True") {
                // クリアした場合の処理
                clear_card(1);
            }
            if ('{{data.game02}}' == "True") {
                // クリアした場合の処理
                clear_card(2);
            }
            if ('{{data.game03}}' == "True") {
                // クリアした場合の処理
                clear_card(3);
            }
            if ('{{data.game04}}' == "True") {
                // クリアした場合の処理
                clear_card(4);
            }
            if ('{{data.game05}}' == "True") {
                // クリアした場合の処理
                clear_card(5);
            }
            if ('{{data.game06}}' == "True") {
                // クリアした場合の処理
                clear_card(6);
            }
            function clear_card(id) {
                const overlayImage = document.createElement('img');
                overlayImage.src = "{% static 'lover/images/clear.png' %}";
                overlayImage.classList.add("clear-overlay");
                document.getElementById(`Q0${id}_card`).appendChild(overlayImage);  // clear.png を linkCard に追加
                document.getElementById(`Q0${id}_card`).removeAttribute('onclick');
            }
        };

    </script>
</body>

</html>