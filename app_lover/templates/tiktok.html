<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="kiwitok">
    <title>å‹•ç”»ãƒ•ã‚£ãƒ¼ãƒ‰</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        .video-wrapper {
            transition: transform 1s ease;
            /* 1ç§’ã§å¤‰åŒ–ã•ã›ã‚‹ */
        }

        .hidden {
            transform: translateY(100%) !important;
            /* éš ã‚Œã‚‹æ™‚ã«é€æ˜ã«ã™ã‚‹ */
        }


        .overlay {
            position: absolute;
            bottom: 10%;
            left: 10px;
            color: white;
            font-size: 1.2em;
        }

        .mute-button,
        .play-button {
            position: absolute;
            bottom: 15%;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
        }

        .play-button {
            display: none;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            font-size: 24px;
        }
    </style>
</head>

<body>

    <div id="video-feed">
        {% for video in videos %}
        <div class="video-wrapper {% if not forloop.first %}hidden{% endif %}">
            <div class="video-container" onclick="toggleMute(this)">
                <video class="video-player" src="{{ video.video.url }}" playsinline muted loop></video>
                <div class="overlay">
                    <h2>{{ video.title }}</h2>
                    <p>{{ video.description }}</p>
                    <p>â¤ï¸ {{ video.likes }} | ğŸ’¬ {{ video.comments_count }}</p>
                </div>
                <button class="mute-button">ğŸ”‡</button>
                <button class="play-button" onclick="playVideo(this)">â–¶ï¸</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        let currentIndex = 0;
        let videos = document.querySelectorAll('.video-wrapper');
        let videoElements = document.querySelectorAll('.video-player');

        document.addEventListener('DOMContentLoaded', function () {
            let firstVideo = videoElements[0];
            console.log(firstVideo)
            if (firstVideo) {
                firstVideo.play().catch(() => console.log("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ"));
            }
        });

        document.addEventListener('touchstart', function () {
            let firstVideo = videoElements[0];
            if (firstVideo.paused) {
                firstVideo.play();
            }
        }, { once: true });

        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchend', handleTouchEnd, false);

        let startY = 0;

        function handleTouchStart(event) {
            startY = event.touches[0].clientY;
        }

        function handleTouchEnd(event) {
            let endY = event.changedTouches[0].clientY;
            let diffY = startY - endY;

            if (diffY > 50) {  // ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—
                nextVideo();
            } else if (diffY < -50) {  // ä¸‹ã‚¹ãƒ¯ã‚¤ãƒ—
                prevVideo();
            }
        }

        function nextVideo() {
            if (currentIndex < videos.length - 1) {
                let currentVideoWrapper = videos[currentIndex];
                let currentVideo = videoElements[currentIndex];

                // ç¾åœ¨ã®å‹•ç”»ã‚’åœæ­¢
                currentVideo.pause();

                // ç¾åœ¨ã®å‹•ç”»ã«hiddenã‚’è¿½åŠ 
                currentVideoWrapper.classList.add("hidden");

                // æ¬¡ã®å‹•ç”»ã‚’è¡¨ç¤º
                currentIndex++;
                let nextVideoWrapper = videos[currentIndex];
                let nextVideo = videoElements[currentIndex];

                // hiddenã‚’å‰Šé™¤ã—ã¦è¡¨ç¤º
                nextVideoWrapper.classList.remove("hidden");
                nextVideo.play().catch(() => showPlayButton(nextVideo));

                // ã•ã‚‰ã«æ¬¡ã®å‹•ç”»ã‚’äº‹å‰ãƒ­ãƒ¼ãƒ‰
                preloadNextVideo(currentIndex + 1);
            }
        }
        function prevVideo() {
            if (currentIndex > 0) {
                // ç¾åœ¨ã®å‹•ç”»ã‚’éš ã™
                videos[currentIndex].classList.add('hidden');
                let currentVideo = videoElements[currentIndex];
                currentVideo.pause();  // ç¾åœ¨ã®å‹•ç”»ã‚’åœæ­¢

                // å‰ã®å‹•ç”»ã‚’è¡¨ç¤º
                currentIndex--;
                videos[currentIndex].classList.remove('hidden');

                let prevVideo = videoElements[currentIndex];
                prevVideo.play().catch(() => console.log("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ"));
            }
        }

        // æ¬¡ã®å‹•ç”»ã‚’äº‹å‰ãƒ­ãƒ¼ãƒ‰
        function preloadNextVideo(index) {
            if (index < videoElements.length) {
                let video = videoElements[index];
                video.preload = "auto";  // æ¬¡ã®å‹•ç”»ã‚’ãƒ­ãƒ¼ãƒ‰
            }
        }

        // å†ç”Ÿãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showPlayButton(video) {
            let playButton = video.closest(".video-container").querySelector(".play-button");
            playButton.style.display = "block";
        }





        function toggleMute(container) {
            let video = container.querySelector("video");
            let button = container.querySelector(".mute-button");

            if (video.muted) {
                video.muted = false;
                button.textContent = "ğŸ”Š"; // éŸ³å£°ON
                sessionStorage.setItem("muted", "false");  // æ¬¡ã®å‹•ç”»ã«ã‚‚é©ç”¨
            } else {
                video.muted = true;
                button.textContent = "ğŸ”‡"; // éŸ³å£°OFF
                sessionStorage.setItem("muted", "true");
            }
        }

        function showPlayButton(video) {
            let playButton = video.closest('.video-container').querySelector('.play-button');
            playButton.style.display = "block";
        }

        // playãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰å†ç”Ÿ
        function playVideo(button) {
            let video = button.closest(".video-container").querySelector("video");
            video.play();
            button.style.display = "none";
        }

        videoElements.forEach(video => {
            video.addEventListener("ended", function () {
                showPlayButton(video);
            });

            video.addEventListener("play", function () {
                let playButton = video.closest('.video-container').querySelector('.play-button');
                playButton.style.display = "none";  // å†ç”Ÿæ™‚ã«ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
            });
        });

        function reloadStyles() {
            let styleTags = document.querySelectorAll("style");
            styleTags.forEach(tag => {
                let newTag = tag.cloneNode(true);  // æ—¢å­˜ã® <style> ã‚¿ã‚°ã‚’è¤‡è£½
                tag.parentNode.replaceChild(newTag, tag);  // æ–°ã—ã„ã‚¿ã‚°ã§ç½®ãæ›ãˆã‚‹
            });
        }

        // ãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸéš›ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        window.addEventListener("load", reloadStyles);


    </script>

</body>

</html>