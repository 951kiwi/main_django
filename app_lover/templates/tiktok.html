<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="kiwitok">
    <title>動画フィード</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        .video-wrapper {
            transition: transform 1s ease;
            /* 1秒で変化させる */
        }

        .hidden {
            transform: translateY(100%) !important;
            /* 隠れる時に透明にする */
        }


        .overlay {
            position: absolute;
            bottom: 10%;
            left: 10px;
            color: white;
            font-size: 1.2em;
        }

        .mute-button,
        .play-button {
            position: absolute;
            bottom: 15%;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
        }

        .play-button {
            display: none;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            font-size: 24px;
        }
    </style>
</head>

<body>

    <div id="video-feed">
        {% for video in videos %}
        <div class="video-wrapper {% if not forloop.first %}hidden{% endif %}">
            <div class="video-container" onclick="toggleMute(this)">
                <video class="video-player" src="{{ video.video.url }}" playsinline muted loop></video>
                <div class="overlay">
                    <h2>{{ video.title }}</h2>
                    <p>{{ video.description }}</p>
                    <p>❤️ {{ video.likes }} | 💬 {{ video.comments_count }}</p>
                </div>
                <button class="mute-button">🔇</button>
                <button class="play-button" onclick="playVideo(this)">▶️</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        let currentIndex = 0;
        let videos = document.querySelectorAll('.video-wrapper');
        let videoElements = document.querySelectorAll('.video-player');

        document.addEventListener('DOMContentLoaded', function () {
            let firstVideo = videoElements[0];
            console.log(firstVideo)
            if (firstVideo) {
                firstVideo.play().catch(() => console.log("自動再生がブロックされました"));
            }
        });

        document.addEventListener('touchstart', function () {
            let firstVideo = videoElements[0];
            if (firstVideo.paused) {
                firstVideo.play();
            }
        }, { once: true });

        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchend', handleTouchEnd, false);

        let startY = 0;

        function handleTouchStart(event) {
            startY = event.touches[0].clientY;
        }

        function handleTouchEnd(event) {
            let endY = event.changedTouches[0].clientY;
            let diffY = startY - endY;

            if (diffY > 50) {  // 上スワイプ
                nextVideo();
            } else if (diffY < -50) {  // 下スワイプ
                prevVideo();
            }
        }

        function nextVideo() {
            if (currentIndex < videos.length - 1) {
                let currentVideoWrapper = videos[currentIndex];
                let currentVideo = videoElements[currentIndex];

                // 現在の動画を停止
                currentVideo.pause();

                // 現在の動画にhiddenを追加
                currentVideoWrapper.classList.add("hidden");

                // 次の動画を表示
                currentIndex++;
                let nextVideoWrapper = videos[currentIndex];
                let nextVideo = videoElements[currentIndex];

                // hiddenを削除して表示
                nextVideoWrapper.classList.remove("hidden");
                nextVideo.play().catch(() => showPlayButton(nextVideo));

                // さらに次の動画を事前ロード
                preloadNextVideo(currentIndex + 1);
            }
        }
        function prevVideo() {
            if (currentIndex > 0) {
                // 現在の動画を隠す
                videos[currentIndex].classList.add('hidden');
                let currentVideo = videoElements[currentIndex];
                currentVideo.pause();  // 現在の動画を停止

                // 前の動画を表示
                currentIndex--;
                videos[currentIndex].classList.remove('hidden');

                let prevVideo = videoElements[currentIndex];
                prevVideo.play().catch(() => console.log("自動再生がブロックされました"));
            }
        }

        // 次の動画を事前ロード
        function preloadNextVideo(index) {
            if (index < videoElements.length) {
                let video = videoElements[index];
                video.preload = "auto";  // 次の動画をロード
            }
        }

        // 再生ボタンを表示する関数
        function showPlayButton(video) {
            let playButton = video.closest(".video-container").querySelector(".play-button");
            playButton.style.display = "block";
        }





        function toggleMute(container) {
            let video = container.querySelector("video");
            let button = container.querySelector(".mute-button");

            if (video.muted) {
                video.muted = false;
                button.textContent = "🔊"; // 音声ON
                sessionStorage.setItem("muted", "false");  // 次の動画にも適用
            } else {
                video.muted = true;
                button.textContent = "🔇"; // 音声OFF
                sessionStorage.setItem("muted", "true");
            }
        }

        function showPlayButton(video) {
            let playButton = video.closest('.video-container').querySelector('.play-button');
            playButton.style.display = "block";
        }

        // playボタンが押されたら再生
        function playVideo(button) {
            let video = button.closest(".video-container").querySelector("video");
            video.play();
            button.style.display = "none";
        }

        videoElements.forEach(video => {
            video.addEventListener("ended", function () {
                showPlayButton(video);
            });

            video.addEventListener("play", function () {
                let playButton = video.closest('.video-container').querySelector('.play-button');
                playButton.style.display = "none";  // 再生時にボタンを消す
            });
        });

        function reloadStyles() {
            let styleTags = document.querySelectorAll("style");
            styleTags.forEach(tag => {
                let newTag = tag.cloneNode(true);  // 既存の <style> タグを複製
                tag.parentNode.replaceChild(newTag, tag);  // 新しいタグで置き換える
            });
        }

        // ページがロードされた際にスタイルをリロード
        window.addEventListener("load", reloadStyles);


    </script>

</body>

</html>