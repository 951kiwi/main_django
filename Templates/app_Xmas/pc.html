<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Quiz PC</title>

<style>
body {
  font-family: sans-serif;
  background: #f5f5f5;
  padding: 20px;
  margin-top: 100px;
}


h1 {
  text-align: center;
}

/* å•é¡Œã‚¨ãƒªã‚¢ */
.question-box {
  background: #fff;
  border-radius: 12px;
  padding: 30px;
  max-width: 900px;
  margin: 0 auto 20px auto;
}

/* é¸æŠè‚¢ */
.choices {
  max-width: 900px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.choice {
  border: 4px solid #999;
  border-radius: 12px;
  padding: 25px;
  font-size: 24px;
  text-align: center;
  background: #fafafa;
}

/* æ­£è§£å¼·èª¿ */
.choice.correct {
  border-color: gold;
  background: #fff6c5;
}

/* ã‚¿ã‚¤ãƒãƒ¼ */
.timer-area {
  max-width: 900px;
  margin: 25px auto;
}

.timer-text {
  font-size: 24px;
  text-align: center;
  margin-bottom: 10px;
}

.progress-outer {
  width: 100%;
  height: 22px;
  background: #ddd;
  border-radius: 12px;
  overflow: hidden;
}

.progress-inner {
  height: 100%;
  width: 0%;
  background: #2ecc71;
  transition: width 0.4s linear;
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
.player-area {
  position: fixed;
  bottom: 20px;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 14px;
  flex-wrap: wrap;
}

.player {
  width: 130px;
  height: 80px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 18px;
}

/* çŠ¶æ…‹ */
.waiting {
  border: 3px solid #3498db;
  color: #3498db;
}

.answered {
  background: #bdc3c7;
  color: #2c3e50;
}

.correct-player {
  background: #3498db;
  color: white;
}

.wrong-player {
  background: #e74c3c;
  color: white;
}

.finished {
  color: red;
  font-weight: bold;
}
.confetti {
  position: fixed;
  width: 8px;
  height: 14px;
  pointer-events: none;
  z-index: 9999;
  opacity: 0.9;
  animation: confetti-fall 2.8s cubic-bezier(.25,.6,.25,1) forwards;
}

@keyframes confetti-fall {
  0% {
    transform: translate(0, 0) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translate(var(--dx), var(--dy)) rotate(1080deg);
    opacity: 0;
  }
}

</style>
</head>

<body>

<div class="question-box">
  <h1 id="question">å•é¡Œå¾…æ©Ÿä¸­</h1>
</div>

<div class="choices" id="choices" style="display:none;">
  <div class="choice" id="A"></div>
  <div class="choice" id="B"></div>
  <div class="choice" id="C"></div>
  <div class="choice" id="D"></div>
</div>

<div class="timer-area" id="timer-area" style="display:none;">
  <div class="timer-text">
    æ®‹ã‚Š <span id="time-left">--</span> ç§’
    <span id="finish-text" class="finished" style="display:none;">çµ‚äº†</span>
  </div>

  <div class="progress-outer">
    <div class="progress-inner" id="progress-bar"></div>
  </div>
</div>

<div class="player-area" id="players"></div>

<script>
let serverOffset = 0;
let endsAt = null;
let totalTime = 1;
let currentQuestionId = null;
let confettiFired = false;

/* ===== çŠ¶æ…‹å–å¾— ===== */
async function fetchState() {
  const res = await fetch("/Xmas/api/state/");
  const data = await res.json();

  const questionEl = document.getElementById("question");
  const choicesEl = document.getElementById("choices");
  const timerEl = document.getElementById("timer-area");
  const playersEl = document.getElementById("players");

  playersEl.innerHTML = "";

  /* ===== å•é¡Œå¾…æ©Ÿä¸­ ===== */
  if (data.status !== "ok" || !data.question ) {
    questionEl.textContent = "å•é¡Œå¾…æ©Ÿä¸­";
    choicesEl.style.display = "none";
    timerEl.style.display = "none";
  }
  if(!data.accepting){
    endsAt = null;
  }
  else{
    /* ===== ã‚µãƒ¼ãƒãƒ¼æ™‚é–“åŒæœŸ ===== */
    const serverNow = new Date(data.server_now).getTime();
    serverOffset = serverNow - Date.now();
    endsAt = new Date(data.ends_at).getTime();

    /* ===== å•é¡Œåˆ‡æ›¿ ===== */
    if (currentQuestionId !== data.question.id) {
      currentQuestionId = data.question.id;
      totalTime = Math.max(
        1,
        Math.ceil((endsAt - serverNow) / 1000)
      );
    }
    
    /* ===== è¡¨ç¤º ===== */
    choicesEl.style.display = "grid";
    timerEl.style.display = "block";
  }
    if (!data.show_answer) {
      confettiFired = false;
    }
  
  questionEl.textContent = data.question.text;

  

  ["A","B","C","D"].forEach(k => {
    const el = document.getElementById(k);
    el.textContent = data.question.choices[k];
    el.classList.remove("correct");
  });

  /* ===== æ­£è§£è¡¨ç¤º ===== */
  if (data.show_answer) {
    document.getElementById(data.question.correct).classList.add("correct");
  }

  /* ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===== */
  if (data.players) {
    data.players.forEach(p => {
      const div = document.createElement("div");
      div.textContent = p.name;

      if (data.show_answer) {
        div.className = "player " + (p.is_correct ? "correct-player" : "wrong-player");
        // ğŸ‰ æ­£è§£è€…ã‹ã‚‰ã‚¯ãƒ©ãƒƒã‚«ãƒ¼
        if (p.is_correct && !confettiFired) {
          setTimeout(() => fireConfettiFrom(div), 100);
        }

      } else if(p.answered){
        div.className = "player answered";
      }
      else {
        div.className = "player waiting";
      }
      playersEl.appendChild(div);
    });
    // å…¨å“¡å‡¦ç†å¾Œã«ãƒ•ãƒ©ã‚°ON
    if (data.show_answer) {
      confettiFired = true;
    }
  }
  
}

/* ===== ã‚¿ã‚¤ãƒãƒ¼æç”» ===== */
function updateTimer() {
  if (!endsAt) return;

  const now = Date.now() + serverOffset;
  const remaining = Math.max(0, Math.ceil((endsAt - now) / 1000));

  document.getElementById("time-left").textContent = remaining;

  const percent = Math.max(0, (remaining / totalTime) * 100);
  document.getElementById("progress-bar").style.width = percent + "%";

  document.getElementById("finish-text").style.display =
    remaining === 0 ? "inline" : "none";
}

/*  ==== ã‚¯ãƒ©ãƒƒã‚«ãƒ¼ ====*/
function fireConfettiFrom(element) {
  const rect = element.getBoundingClientRect();
  const x = rect.left + rect.width / 2;
  const y = rect.top + rect.height / 2;

  const colors = ["#f1c40f", "#e67e22", "#e74c3c", "#3498db", "#2ecc71"];

  for (let i = 0; i < 120; i++) {
    const confetti = document.createElement("div");
    confetti.className = "confetti";

    const color = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.background = color;

    const dx = (Math.random() - 0.5) * 400 + "px";
    const dy = -(Math.random() * (-200 - 200) + 200) + "px";

    confetti.style.left = x + "px";
    confetti.style.top = y + "px";
    confetti.style.setProperty("--dx", dx);
    confetti.style.setProperty("--dy", dy);

    document.body.appendChild(confetti);

    setTimeout(() => confetti.remove(), 4500);
  }
}

/* ===== å®Ÿè¡Œ ===== */
setInterval(fetchState, 1000);   // çŠ¶æ…‹åŒæœŸ
setInterval(updateTimer, 100);   // è¡¨ç¤ºæ›´æ–°

fetchState();
</script>


</body>
</html>
